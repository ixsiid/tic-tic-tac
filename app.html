<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tic Tic Tac</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            border: none;
        }

        html,
        body {
            width: 100%;
        }

        #content {
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            justify-content: space-between;
            align-items: center;

            padding: 5vw;
            height: calc(100vh - 10vw);
        }

        .player2 {
            transform-origin: 50% 50%;
            transform: rotate(180deg);
        }

        #content div.flex {
            padding: 2vw;
            width: 100%;
        }

        #content table {
            height: 100%;
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
        }

        #content td {
            border: 1px solid black;
        }

        #content button {
            width: 40vw;
            height: 8vw;
            padding: 2vw;
            background: lightgray;
            border: 1px solid black;
            border-radius: 4vw;
            margin: 2vw;
        }

        #content td .piece {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;

            padding: 0;
            margin: auto;
            width: 65%;
            height: 65%;

            border: rgba(0, 0, 0, 0) 2px solid;
            border-radius: 50%;
        }

        #content td {
            --p1: red;
            --p2: blue;
        }

        #content td.small1>*>*>.piece,
        #content td.middle1>*>.piece,
        #content td.large1>.piece {
            border-color: var(--p1);
        }

        #content td.small2>*>*>.piece,
        #content td.middle2>*>.piece,
        #content td.large2>.piece {
            border-color: var(--p2);
        }

        #content .pick1 {
            background-color: rgba(255, 0, 0, 0.08);
        }

        #content .put1 {
            background-color: rgba(255, 0, 0, 0.2);
        }

        #content .pick2 {
            background-color: rgba(0, 0, 255, 0.08);
        }

        #content .put2 {
            background-color: rgba(0, 0, 255, 0.2);
        }

        #content #move {
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        #controller {
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            justify-content: space-evenly;
            align-items: center;

            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.3);

            visibility: hidden;
        }

        #controller .result {
            font-size: 11vw;
            margin: 2vw;
            padding: 1vw 8vw;
            text-shadow:
                1vw 1vw 1vw white,
                1vw -1vw 1vw white,
                -1vw 1vw 1vw white,
                -1vw -1vw 1vw white;
        }

        #controller button {
            font-size: 7vw;
            background-color: white;
            border: 1px solid black;
            border-radius: 4vw;
        }

        #controller button span {
            display: inline-block;
            padding: 2vw;
        }



        #config {
            display: none;
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }

        #config #qr {
            width: 1.5em;
            height: 2em;
            padding: 0.2em;
            position: absolute;
            left: 0;
            background-color: black;
            top: calc(50vh - 1.1em);
            border-radius: 0 25% 25% 0;
        }

    </style>
    <script>
        const rule = {
            pick: [],
            put: [],
            accept: [],
        };

        const pieces = { small: 0, middle: 1, large: 2 };
        const priority_piece = td => {
            return [].map.call(td.classList, x => x)
                .sort((a, b) => pieces[b.slice(0, -1)] - pieces[a.slice(0, -1)])[0];
        };

        rule.pick.push((td, p) => {
            let table = td.parentElement;
            while (table.tagName != 'TABLE') table = table.parentElement;

            if (table.classList.contains('stock')) {
                if (table.classList.contains(`player${p}`)) {
                    return td.classList.length > 0;
                }
            }

            if (table.classList.contains('board')) {
                if (td.classList.length == 0) return false;

                return priority_piece(td).slice(-1) == p;
            }
        });

        rule.put.push((td, _) => {
            let table = td.parentElement;
            while (table.tagName != 'TABLE') table = table.parentElement;

            if (!table.classList.contains('board')) return false;

            if (td.classList.length == 0) return true;

            const p = pieces[status.pick.slice(0, -1)];

            const q = pieces[priority_piece(td).slice(0, -1)];
            return p > q;
        });

        const MaxPlayer = 2;
        const Commands = ['pick', 'put', 'accept'];
        const status = {
            player: 0,
            command: 'accept',
            pick: '',
            move: [],
        };

        const phase = (prev, current) => {
            [].map.call(document.querySelectorAll('td'), x => {
                x.classList.remove('clickable');
                x.classList.remove(`${prev.command}${prev.player}`);

                for (let r of rule[current.command]) {
                    if (r(x, current.player)) {
                        x.classList.add('clickable');
                        x.classList.add(`${current.command}${current.player}`);
                        break;
                    }
                }
            });
        };

        const draw_move = () => {
            const context = document.querySelector('#move')
                .getContext('2d');
            const center = element => {
                rect = element.getBoundingClientRect();
                return [
                    (rect.left + rect.right) / 2,
                    (rect.top + rect.bottom) / 2,
                ];
            };

            const style = {
                1: '#F00',
                2: '#00F',
            };
            context.lineCap = 'round';
            context.lineWidth = 5;

            const points = status.move.map(x => center(x));
            const distance = Math.sqrt(Math.pow(points[0][0] - points[1][0], 2) + Math.pow(points[0][1] - points[1][1], 2));
            const gradient = context.createLinearGradient(...points[0], ...points[1]);
            gradient.addColorStop(0.3, style[status.player]);
            gradient.addColorStop(1, '#FFF');
            context.strokeStyle = gradient;

            context.beginPath();
            context.moveTo(...points[0]);
            context.lineTo(...points[1]);
            context.stroke();
        };

        const clear_move = () => {
            const canvas = document.querySelector('#move');
            const context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
        };

        const next = () => {
            const prev = { ...status };
            switch (status.command) {
                case 'pick':
                    status.command = 'put';
                    break;
                case 'put':
                    status.command = 'accept';
                    draw_move();
                    break;
                case 'accept':
                    clear_move();

                    const win = is_win();

                    if (win > 0) {
                        document.querySelector('#controller').style.visibility = 'visible';
                        [].map.call(document.querySelectorAll('.result'), x => x.textContent = 'Loose');
                        document.querySelector(`.player${win}.result`).textContent = 'Win';
                    } else {
                        status.player = status.player % MaxPlayer + 1;
                        status.command = 'pick';
                        status.move = [];
                    }
                    break;
                default:
                    status.player = 1;
                    status.command = 'pick';
                    status.pick = '';
                    status.move = [];

                    clear_move();
                    break;
            }
            return prev;
        };

        const revert = p => {
            clear_move();
            if (status.player != p) return;

            const prev = { ...status };
            status.command = 'pick';
            status.move = [];
            phase(prev, status);
        };

        const td_click = td => {
            if (!td.classList.contains('clickable')) return;

            if (status.command == 'pick') {
                status.pick = priority_piece(td);
                status.move.push(td);
            } else if (status.command == 'put') {
                status.move.push(td);
            }

            phase(next(), status);
        };

        const accept = p => {
            if (status.player != p) return;
            if (status.command != 'accept') return;

            status.move[0].classList.remove(status.pick);
            status.move[1].classList.add(status.pick);
            phase(next(), status);
        };

        const new_game = () => {
            const class_clear = element => {
                [].map.call(element.classList, x => x).map(x => element.classList.remove(x));
            };

            const ps = Object.keys(pieces);
            for (let p = 1; p <= MaxPlayer; p++) {
                [].map.call(document.querySelectorAll(`.stock.player${p} td`), (x, i) => {
                    class_clear(x);
                    x.classList.add(`${ps[i % ps.length]}${p}`);
                });
            }

            [].map.call(document.querySelectorAll(`.board td`), (x, i) => {
                class_clear(x);
            });

            document.querySelector('#controller').style.visibility = 'hidden';

            phase(next(), status);
        };

        const is_win = () => {
            const board = [].map.call(document.querySelectorAll('.board td'), x => {
                const p = priority_piece(x);
                if (!p) return 0;
                return parseInt(p.slice(-1));
            });

            const l = Math.sqrt(board.length);
            const board2x = board.reduce((a, b) => {
                let t = a[a.length - 1];
                if (t.length >= l) {
                    t = [];
                    a.push(t);
                }
                t.push(b);
                return a;
            }, [[]]);

            // 横
            for (let i = 0; i < l; i++) {
                const w = board2x[i].reduce((a, b) => a == b ? a : 0);
                if (w > 0) return w;
            }

            // 縦
            for (let i = 0; i < l; i++) {
                const w = board2x.reduce((a, b) => a[i] == b[i] ? b : 0)[i];
                if (w > 0) return w;
            }

            // 斜め
            const s1 = board2x.reduce((a, b, i) => a[i - 1] == b[i] ? b : 0)[l - 1];
            if (s1 > 0) return s1;
            const s2 = board2x.reduce((a, b, i) => a[l - i] == b[l - i - 1] ? b : 0)[0];
            if (s2 > 0) return s2;

            return 0;
        }

        const outline = false;

        const layout = size => {
            document.querySelector('table.board').parentElement.style.flexGrow = size;
            [].map.call(document.querySelectorAll('#content table'), x => {
                x.style.width = '100%';
                x.style.height = '100%';

                [].map.call(x.querySelectorAll('tr'), x => {
                    x.parentElement.removeChild(x);
                });
            });


            [].map.call(document.querySelectorAll('#content table.stock tbody'), x => {
                for (let i = 0; i < 2; i++) {
                    const tr = document.createElement('tr');
                    for (let j = 0; j < size; j++) {
                        const td = document.createElement('td');
                        td.addEventListener('click', () => td_click(td), false);

                        let p = td;
                        for (let k = 0; k < size; k++) {
                            const piece = document.createElement('div');
                            piece.classList.add(`piece`);
                            p.appendChild(piece);
                            p = piece;
                        }
                        tr.appendChild(td);
                    }
                    x.appendChild(tr);
                }
            });

            const board = document.querySelector('#content table.board tbody');
            for (let i = 0; i < size; i++) {
                const tr = document.createElement('tr');
                for (let j = 0; j < size; j++) {
                    const td = document.createElement('td');
                    td.addEventListener('click', () => td_click(td), false);

                    let p = td;
                    for (let k = 0; k < size; k++) {
                        const piece = document.createElement('div');
                        piece.classList.add(`piece`);
                        p.appendChild(piece);
                        p = piece;
                    }
                    
                    tr.appendChild(td);
                }
                board.appendChild(tr);
            }

            // サイズの計算と設定を同時に行うと、
            // 後続する要素サイズが変わるため、
            // 最初にすべての要素サイズを計算する。
            // 計算が終わったら設定する
            const stock_sizes = [].map.call(document.querySelectorAll('#content table.stock'), x => {
                const table_size = x.getBoundingClientRect();
                return Math.min(table_size.width, table_size.height);
            });
            const board_size = document.querySelector('#content table.board').getBoundingClientRect();
            const bsize = Math.min(board_size.width, board_size.height);

            [].map.call(document.querySelectorAll('#content table.stock'), (x, i) => {
                x.style.width = stock_sizes[i] / 2 * size + 'px';
                x.style.height = stock_sizes[i] + 'px';
            });
            document.querySelector('#content table.board').style.width = bsize + 'px';
            document.querySelector('#content table.board').style.height = bsize + 'px';
        }

        const size = 3;

        window.addEventListener('load', () => {
            layout(size);

            const button_command = { revert, accept };

            [].map.call(document.querySelectorAll('#content button'), x => {
                const p = parseInt(x.parentElement.classList[0].slice(-1));
                x.addEventListener('click', () => button_command[x.classList[0]](p), false);
            });

            {
                const rect = document.querySelector('#move').getBoundingClientRect();
                move.setAttribute('width', rect.width);
                move.setAttribute('height', rect.height);
            }

            document.querySelector('#restart').addEventListener('click', new_game, false);

            (outline ? phase(next(), status) : new_game());
        }, false);
    </script>
</head>

<body>
    <div id="content">
        <!--
            初期値はスクリプトでリセットする
            直書きの初期値はデザイン確認用
        -->
        <p class="player2 command" style="flex-grow: 0">
            <button class="revert">Revert</button>
            <button class="accept">Accept</button>
        </p>
        <div class="flex" style="flex-grow: 2">
            <table class="player2 stock">
                <tr>
                    <td></td>
                    <td></td>
                    <td class="large2"></td>
                </tr>
                <tr>
                    <td class="small2"></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
        </div>
        <div class="flex">
            <table class="board">
                <tr>
                    <td class="small2 middle2 large1"></td>
                    <td class="small1"></td>
                    <td></td>
                </tr>
                <tr>
                    <td class="large1"></td>
                    <td class="small1 middle2"></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td class="large2"></td>
                </tr>
            </table>
        </div>
        <div class="flex" style="flex-grow: 2">
            <table class="player1 stock">
                <tr>
                    <td></td>
                    <td class="middle1"></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td class="middle1"></td>
                    <td></td>
                </tr>
            </table>
        </div>
        <p class="player1 command" style="flex-grow: 0">
            <button class="revert">Revert</button>
            <button class="accept">Accept</button>
        </p>
        <canvas id="move"></canvas>
    </div>
    <div id="config">
        <p id="qr">QR</p>
    </div>
    <div id="controller">
        <div class="player2 result">Win</div>
        <div><button id="restart"><span class="player2">再</span><span>戦</span></button></div>
        <div class="player1 result">Loose</div>
    </div>
</body>

</html>
